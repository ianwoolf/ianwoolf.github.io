<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<meta name="generator" content="Hexo 6.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        
          <a class="nav-icon" href="/atom.xml" title="RSS Feed"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="Search"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-recovery-1" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2024/03/31/recovery-1/" class="article-date">
  <time class="dt-published" datetime="2024-03-31T11:16:00.000Z" itemprop="datePublished">2024-03-31</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2024/03/31/recovery-1/">根因分析与⾃愈 -- 概述</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>每个公司、每个业务都时刻⾯临在基础设施、服务或配置变更、流量突增、⿊产刷量等带来的⻛险。 这些⻛险可能导致业务可⽤性降低、业务收到不同程度的影响、资⾦损失等。推进业务稳定性建设， 可以有效的提⾼业务稳定性，减⼩各种异常发⽣时带来的损失，降低业务的⻛险。</p>
<h1 id="⽬标"><a href="#⽬标" class="headerlink" title="⽬标"></a>⽬标</h1><p>提⾼业务稳定性不仅是⼀个句⼝号，也不是简单的报警系统。系统越复杂，对稳定性的要求越⾼。对 于抖⾳或公有云这种重要或复杂程度⽐较⾼的业务来说，稳定性需要从基础设施、发布管理、数据管 理、业务规范等⽅⾯综合进⾏。总体上稳定性有以下⼏个⽬标 </p>
<ul>
<li>降低故障发⽣概率</li>
</ul>
<p>做好代码审查，做好压⼒测试及容量管理，配置及代码发布过程中的流量管控等可以有效减少异常的 发⽣。 </p>
<ul>
<li>降低故障影响</li>
</ul>
<p>早期发现，快速定位原因，及时⽌损或降级业务，并跟进故障中发现的问题，可以有效减少异常的持 续时间和影响。 </p>
<h1 id="mttr"><a href="#mttr" class="headerlink" title="mttr"></a>mttr</h1><p>MTTR(MeanTime to Repair) 是衡量从检测到异常到修复所需时间的指标。它是衡量稳定施⼯质量的关 键指标之⼀。mttr主要包含了3个阶段：发现、定位、⽌损。 </p>
<p><img src="/images/atuo_recovery_1/recovery_1.PNG" alt="image"></p>
<ul>
<li>发现：这个时间通常被定义为异常开始到相关同学关注报警所花费时间。</li>
</ul>
<p>通过业务数据监控和服务监控，提早感知业务、服务的异常变化。 </p>
<ul>
<li>定位：从感知到定位到故障原因所花费的时间。</li>
</ul>
<p>⽬前⼤多还是靠指标⼤盘、trace分析等⼿段辅助⼈⼯进⾏快速分析。⼀⽅⾯可以通过trace等串联业务 ⼤盘，通过业务⼤盘和业务数据加快故障影响程度的判定和异常原因的分析；另⼀⽅⾯可以结合数据 和时间进⾏根因分析，辅助报警分析或触发⽌损操作。 </p>
<ul>
<li>⽌损：开始执⾏⽌损操作，到异常现象消失的时间。⽌损操作可能有⼈⼯触发，也可能根据配置进 ⾏⾃动触发。</li>
</ul>
<p>mttr(Mean Time To Repair)不仅是因为它可以衡量⼀个团队发现故障、定位故障、解决故障的整体能力，更因为可以通过结合故障时间和资损衡量出稳定性优化带来的收益，让之前⼤家都不重视的稳定 性⼯作变得是⼀个有收益产出的⼯作。有了收益指标，推动稳定性⼯作会更加容易。 </p>
<h1 id="异常与根因分析"><a href="#异常与根因分析" class="headerlink" title="异常与根因分析"></a>异常与根因分析</h1><p>就像组成⼈体的各个器官，很多个服务互相依赖、配合完成⼀个产品的各种功能。当⼀个服务出问题 时，有可能在未查明根因时直接执⾏⽌损或降级动作，就像发烧不管原因先吃退烧药⼀样。但更多情 况下需要根据故障原因执⾏⽌损操作。根因定位是个复杂的过程，需要查看服务或业务指标判断异常 的影响程度及范围，结合当前服务、依赖服务、⽹络等各种监控和⽇志确定根因。路是⼀步步⾛的， 我们⾄少可以模仿有经验⼈员的通⽤排查逻辑，给报警推荐根因或⾃动执⾏⽌损动作。 </p>
<h2 id="分析物料和算法"><a href="#分析物料和算法" class="headerlink" title="分析物料和算法"></a>分析物料和算法</h2><p>根因分析是个复杂的过程，根据配置的决策树，可能会⽤到⽇志、trace、监控、事件等各种数据源以 及预聚合的结果。数据是物料，⽽算法就是从数据中提取信息的⽅法。以下是两个例⼦，⽤来说明分 析过程中数据和算法的作⽤ </p>
<ul>
<li><p>某个服务sla发⽣异常：如果某个下游依赖或数据库如果有形状相似的负载异常或服务错误，那么可 以判断这个下游依赖和报警有⼀定关联度。如果⽆法找到具体根因，但是发现错误集中在某个机 房，可以先通过切流进⾏⽌损。 </p>
</li>
<li><p>某个服务发⽣请求量异常：那么通过分析是否有某个agent、机房、源地址、uri的请求量较⾼且形 状相似，可以判断是哪类请求量导致请求量突增并辅助限流决策。</p>
</li>
</ul>
<p><img src="/images/atuo_recovery_1/recovery_2.PNG" alt="image"></p>
<h2 id="分析决策树"><a href="#分析决策树" class="headerlink" title="分析决策树"></a>分析决策树</h2><p>我们分析并模仿了⼈类分析问题的逻辑，将各种问题的通⽤分析流程落地成多个决策树，并⽀持业务 ⾃定义分析决策树。通过分析异常的影响（影响⾯及影响程度）、以及可能的异常根因（下游依赖异 常、单实例、单集群、单机房、业务错误码异常等），通过提供更多信息帮助业务快速定位、快速⽌ 损。甚⾄⾃动执⾏降级、切流等任务以进⾏快速⽌损。</p>
<p><img src="/images/atuo_recovery_1/recovery_3.PNG" alt="image"></p>
<p>还可以给决策树上的不同节点和分析出的根因增加权重，优化最后的根因排序。这个可以通过分析结 果的feedback⽤ai进⾏不断迭代权重。 </p>
<h2 id="根因的属性及排序"><a href="#根因的属性及排序" class="headerlink" title="根因的属性及排序"></a>根因的属性及排序</h2><p>在警报触发分析或⼿动触发分析后，RCA将从各种数据源中提取的材料选择⼀棵或多棵决策树进⾏分 析。</p>
<p>决策树的每个叶⼦节点都可以输出⼀个可能的原因，最后根据服务依赖程度、服务类型、权重等设置 的异常得分对原因进⾏排序。RCA将找出最可能的根本原因，并将这些原因及其材料发送到警报系统 和恢复系统。</p>
<p><img src="/images/atuo_recovery_1/recovery_4.PNG" alt="image"></p>
<p>对于重要服务和报警，⽤⼾也可以指定某个根因及其属性，⾃动执⾏⽌损动作。⽐如服务的某个集 群，出现sla问题可以⾃动执⾏⽌损或切流动作。从⽽尽可能降低故障影响时间，减少故障的影响时⻓ 及资产损失。 </p>
<h2 id="⽌损动作"><a href="#⽌损动作" class="headerlink" title="⽌损动作"></a>⽌损动作</h2><p>在业务的初始阶段，重新启动脚本可能⾜以从异常中恢复服务。随着业务变得越来越复杂，我们需要 ⼀个系统，使⽤配置或服务版本管理、流量管理、http或RPC发送器等原⼦操作来组装、管理和执⾏复 杂的任务。这些任务可能是我们的业务和服务能够尽快从异常中恢复的最后保证。当⼀些意外异常或 致命事件发⽣时，我们希望通过设置⼀些参数，尽快选择⼀个作业执⾏。</p>
<p><img src="/images/atuo_recovery_1/recovery_5.PNG" alt="image"></p>
<p>原⼦操作可以包含流量在各机房的配⽐、配置管理、上线单回滚等。可以抽象成符合规范的操作或第 三⽅平台的任务，都可以抽象成原⼦操作。任意个原⼦操作可以编排成具有⼀定复杂度的任务，⽤于 ⽌损、降级、物理机扩容等操作层⾯的执⾏任务。笔者之前在某幸咖啡时从头实现了⼀套命令系统， 可以配置新建并管理k8s集群、新建es集群等任务（申请⼏台机器-&gt;机器初始化-&gt;按照jvm环境-&gt;下 载、安装、破解es-&gt;更改集群中每台es配置-&gt;启动es集群并验证）。 </p>
<p>有了类似这种操作平台，我们就可以⾃⾏编排⽌损操作了。切流、降级、k8s集群扩容、更改配置、更 改流量平台配置等，只要你能想得到，剩下的就是开发原⼦操作和编排任务的事情了。 </p>
<h1 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h1><p>在某跳动的某⾳业务，我们实现了⼀套根因分析到⾃动⽌损的平台。其实不⽌报警触发，⽇常的⽌损 流程验证及流量压测等功能也都⽤到了这套服务。根因分析和⾃愈这套，其实本质上就是在观察、分 析、决策的各个环节中将⼈类的经验进⾏提炼和落地。后⾯也可以再通过ai进⾏迭代。 </p>
<p>不只是互联⽹服务，其实⽣活中也⽆⾮是观察-&gt;决策-&gt;动作。在⽣活中也可以在各个场景进⾏配置这套 流程，⽐如⽇照+⽓温+湿度+是否⼯作⽇ -&gt; 决策树 -&gt; 智能家居或农场等各种操作。我觉得还是有很⼴ 阔的想象空间的，如果有意愿⼀起做点事情的可以联系我。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2024/03/31/recovery-1/" data-id="clufftnxe00002wcq3n6j7kwh" data-title="根因分析与⾃愈 -- 概述" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-ebpf-install-and-test" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/12/31/ebpf-install-and-test/" class="article-date">
  <time class="dt-published" datetime="2021-12-31T13:47:30.000Z" itemprop="datePublished">2021-12-31</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/devops/">devops</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2021/12/31/ebpf-install-and-test/">ebpf之bcc的安装及测试</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><p>bcc的安装貌似有些坑，开始我再ubuntu上按照<a target="_blank" rel="noopener" href="https://github.com/iovisor/bcc/blob/master/INSTALL.md#ubuntu---source">官方文档</a>安装后运行失败了，有点帖子说需要自己编译安装。但是我的vps每次编译bcc都挂，后来换成centos8用下载rpm包安装成功了。</p>
<h2 id="ubuntu-20-04"><a href="#ubuntu-20-04" class="headerlink" title="ubuntu 20.04"></a>ubuntu 20.04</h2><p>尝试apt安装失败（<a target="_blank" rel="noopener" href="https://github.com/iovisor/gobpf/issues/214">issue</a>），源码编译安装，机器负载过高失败。最后参考帖子下周release的源码编译安装，机器仍然负载过高没有结果。</p>
<p>这tm也太曲折了。可现在ebpf这么火，虽然bbc可能不如cilium应用得多。但是bbc推出得更早，而且可以对接python，应用的人也很多，安装方面不应该这么多坑才对。所以重新调整一下，放弃源码编译安装。把虚拟机重装成了centos8系统，准备直接安装rpm包。</p>
<h2 id="centos8"><a href="#centos8" class="headerlink" title="centos8"></a>centos8</h2><p>在网站查看bcc相关rpm包，用dnf安装了3个包：</p>
<ul>
<li><p>bcc-devel</p>
</li>
<li><p>bcc</p>
</li>
<li><p>bcc-tools</p>
<pre><code>  dnf install bcc-tools
  dnf install bcc
  dnf –enablerepo=powertools install bcc-devel

  git clone git@github.com:DavadDi/bpf_demo.git
  ./main –binary ../tracee/main -func main.ebpfDemo
</code></pre>
</li>
</ul>
<p>成功了，并且测试了一个用ebpf修改函数参数的小demo。可以开始学习了。</p>
<p>但是遗憾的是，在做http相关测试的时候报错了：</p>
<pre><code>    /root/go/pkg/mod/github.com/iovisor/gobpf@v0.0.0-20200614202714-e6b321d32103/bcc/module.go:261:33: not enough arguments in call to _C2func_bpf_attach_uprobe
            have (_Ctype_int, uint32, *_Ctype_char, *_Ctype_char, _Ctype_ulong, _Ctype_int)
            want (_Ctype_int, uint32, *_Ctype_char, *_Ctype_char, _Ctype_ulong, _Ctype_int, _Ctype_uint)
</code></pre>
<p>搜索到一个<a target="_blank" rel="noopener" href="https://github.com/containers/oci-seccomp-bpf-hook/issues/69">issue</a>怀疑是bcc-devel的版本低，有人编译bcc解决。</p>
<h1 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h1><h2 id="测试静态跟踪点（usdt）"><a href="#测试静态跟踪点（usdt）" class="headerlink" title="测试静态跟踪点（usdt）"></a>测试静态跟踪点（usdt）</h2><p>看了这个<a target="_blank" rel="noopener" href="https://ebpf.top/post/ebpf-overview-part-5/">文章</a></p>
<p>期间安装了一些python设置跟踪点的依赖（centos8中进行）</p>
<pre><code>    dnf install elfutils-libelf-devel
    # dnf报错，编译安装解决
    git clone git@github.com:sthima/libstapsdt.git
    cd libstapsdt/
    make
    yum install yum -y install gcc automake autoconf libtool make
    yum -y install gcc automake autoconf libtool make
    make
    make install
    ldconfig

    pip3 install stapsdt
</code></pre>
<h2 id="动态探针（uprobes）"><a href="#动态探针（uprobes）" class="headerlink" title="动态探针（uprobes）"></a>动态探针（uprobes）</h2><p>静态跟踪点的问题在于，它们需要在源代码中明确定义，并且在修改跟踪点时需要重新构建应用程序。保证现有跟踪点的 ABI 稳定性对维护人员如何重新构建&#x2F;重写跟踪点数据的代码施加了限制。</p>
<p>bcc的example<a target="_blank" rel="noopener" href="https://github.com/iovisor/bcc/blob/master/tools/gethostlatency.py">gethostlatency.py</a> 示范了用监控所有dns的查询用时。有几个点可以关注下，后面自己写程序用得到：</p>
<ul>
<li>读取参数的c宏PT_REGS_PARM1。根据<a target="_blank" rel="noopener" href="https://mozillazg.com/2021/05/ebpf-gobpf-get-function-argument-values-from-pt_regs.html">帖子</a></li>
<li>bpf_get_current_comm</li>
<li><a target="_blank" rel="noopener" href="https://www.ebpf.top/post/ebpf_prog_pid_filter/">bpf_get_current_pid_tgid</a>。高 32 位置为 tgid ，低 32 位为 pid(tid)。</li>
<li>BPF_HASH(start, u32, struct val_t);声明一个start数据结构，entry写，return读并删。</li>
<li>BPF_PERF_OUTPUT。BPF_PERF_OUTPUT(events);声明，events.perf_submit生成输出数据，PYTHON代码中B[“events”].event(data)接受数据。</li>
</ul>
<p>但是这个程序有个点不太理解，c中在entry中用线程tgid作为key记录时间、host等信息，return中用tgid在BPF_HASH中读取出来，如果一个go进程重复的进行curl，我理解可能会在一个线程（go PMG中的P）中进行，可能会是一个线程吧？那这个tgid怎么记录呢，会不会乱呢？</p>
<h3 id="测试一"><a href="#测试一" class="headerlink" title="测试一"></a>测试一</h3><p>写了一个bash，进行几次curl请求。并将curl请求扔进后台进行处理。发现两次pid及tgid均不同，难道每次curl是启动一个新进程？</p>
<h3 id="测试二"><a href="#测试二" class="headerlink" title="测试二"></a>测试二</h3><p>写了个go代码循环请求某域名，但是发现go进行http请求gethostlatency.py竟然无任何输出！ 用gccgo编译也不行，目前尚不知道原因。。。</p>
<h3 id="测试三：go函数lantency"><a href="#测试三：go函数lantency" class="headerlink" title="测试三：go函数lantency"></a>测试三：go函数lantency</h3><p>想测试bcc的funclantency，搞了半天搞不通。发现go的bcc包的&#x2F;usr&#x2F;lib&#x2F;python3.6&#x2F;site-packages&#x2F;bcc&#x2F;<strong>init</strong>.py 好像有点问题，path.encode()是byte，不能直接和string相加。可能是python版本问题？不太清楚，反正python3.6这样改一下就好了：</p>
<pre><code>    - exe_file = os.path.join(path.encode(), bin_path)
    + #exe_file = os.path.join(path.encode(), bin_path)
    + exe_file = os.path.join(path, bin_path)
</code></pre>
<p>又yum安装了gccc-go，可以测试了。</p>
<p>先用gccgo编译并运行</p>
<pre><code>    # gccgo -o app t.go
    # ./app
</code></pre>
<p>在另一终端运行funclatency分析fmt.Println调用时长</p>
<pre><code>    # ./funclatency &#39;go:fmt.Println&#39;

    Function = b&#39;fmt.Println&#39; [79990]
    nsecs               : count     distribution
    0 -&gt; 1          : 0        |                                        |
    2 -&gt; 3          : 0        |                                        |
    4 -&gt; 7          : 0        |                                        |
    8 -&gt; 15         : 0        |                                        |
    16 -&gt; 31         : 0        |                                        |
    32 -&gt; 63         : 0        |                                        |
    64 -&gt; 127        : 0        |                                        |
    128 -&gt; 255        : 0        |                                        |
    256 -&gt; 511        : 0        |                                        |
    512 -&gt; 1023       : 0        |                                        |
    1024 -&gt; 2047       : 0        |                                        |
    2048 -&gt; 4095       : 0        |                                        |
    4096 -&gt; 8191       : 0        |                                        |
    8192 -&gt; 16383      : 3        |*******                                 |
    16384 -&gt; 32767      : 12       |****************************            |
    32768 -&gt; 65535      : 17       |****************************************|
    65536 -&gt; 131071     : 2        |****                                    |
    avg = 37622 nsecs, total: 1279163 nsecs, count: 34
</code></pre>
<h3 id="测试四：获取函数调用及参数"><a href="#测试四：获取函数调用及参数" class="headerlink" title="测试四：获取函数调用及参数"></a>测试四：获取函数调用及参数</h3><pre><code>    # cd /root/go/src
    # cat add.go

            package main

            import &quot;fmt&quot;

            func add(x int, y int) int &#123;
            return x + y
            &#125;
            func main() &#123;
            fmt.Println(add(42, 13))
            &#125;
    # gccgo -o add add.go
    # ./add
</code></pre>
<p>在另一终端运行</p>
<pre><code>    # trace &#39;/root/go/src/add:main.add&#39; &quot;%d %d&quot; arg1, arg2&#39;
    PID     TID     COMM            FUNC             -
    80046   80046   add             main.add         42 13
</code></pre>
<p>这里注意：这里是gccgo编译的。如果是go编译，因为Go gc编译器并不遵循标准的 AMD ABI 函数调用约定， 这导致这个调试器或者其它的调试器跟踪参数有问题(我以前也听过前同事抱怨过这个问题)。我猜Go需要使用一个不同的ABI来返回值， 因为它需要返回多个值。（抄的<a target="_blank" rel="noopener" href="https://www.brendangregg.com/blog/2017-01-31/golang-bcc-bpf-function-tracing.html">大神的博客</a>，详情请见原文）</p>
<p>不知道大神改了啥，从go栈地址拿到了参数内容。我就跳过了，估计短期我还用不到这，惭愧。</p>
<h3 id="测试五：监控程序产生的的http包"><a href="#测试五：监控程序产生的的http包" class="headerlink" title="测试五：监控程序产生的的http包"></a>测试五：监控程序产生的的http包</h3><p>iovisor&#x2F;bcc的examples&#x2F;networking&#x2F;http_filter已经写好了bcc过滤http请求及结果的demo。测试http-parse-simple，python代码判断了ethernet包头、ip包头、tcp包头的长度，然后打印了package payload第一行。</p>
<p>例如</p>
<pre><code>    HTTP/1.1 200 OK
    GET /opc/v2/instance/ HTTP/1.1
</code></pre>
<p>这是两个包，第一个是request，第二个是response。因为已经读取出内容，所以我判断应该可以读取出host等其他内容。稍作修改并打印出来：</p>
<pre><code>    GET /e HTTP/1.1
    all package content：\x02\x00\x17\x00\xfc\x7f\x00\x00\x17 \x15\xd6\x08\x00E\x00\x02\n\x00\x00@\x001\x06f\x91=\x87\x98\xfd\n\x00\x00\xd9\xf8\xeb#\x82\x02L\x98m8L\xbe\x12\x80\x18\x08\x02\xf5\xe6\x00\x00\x01\x01\x08\n\x84F\x91E\x87\x04\xdb\xadGET /e HTTP/1.1\r\nHost: myor2:9090\r\nConnection: keep-alive\r\nCache-Control: max-age=0\r\nUpgrade-Insecure-Requests: 1\r\nUser-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/94.0.4606.81 Safari/537.36\r\nAccept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9\r\nAccept-Encoding: gzip, deflate\r\nAccept-Language: zh-CN,zh;q=0.9,en;q=0.8\r\n\r\n

    HTTP/1.1 200 OK
    all package content：\x00\x00\x17 \x15\xd6\x02\x00\x17\x00\xfc\x7f\x08\x00E\x00\x00\xb4XN@\x00@\x06\x00\x99\n\x00\x00\xd9=\x87\x98\xfd#\x82\xf3\xb0\xa6\xa1\xbbe\xe0\xb4\xa5\x9b\x80\x18\x03\x92\xe2\x03\x00\x00\x01\x01\x08\n\x86\xfc\xd5E\x84&gt;\x99WHTTP/1.1 200 OK\r\nDate: Wed, 22 Dec 2021 08:36:59 GMT\r\nContent-Length: 11\r\nContent-Type: text/plain; charset=utf-8\r\n\r\ne = 2.7183\n
</code></pre>
<p>可以看到，其实可以从request包中拿到Host以及http header。但是这里有个问题，如何将request和response对起来呢？从http-parse-complete可以看到，是用源、目的ip&#x2F;port4元组将request和response联系起来的。不过我的环境里response运行不通过，ip和port的偏移量有问题。</p>
<p>受http-parse-complete.py的启发，可以用4元组做记录request并在response到来的时候计算duration。这样可以用作http的监控了。不需要日志、监控，甚至不需要业务的配合，简直完美！不过遗憾的是我的环境下complete跑步起来，判断ip的偏移量有问题。</p>
<p>另外吐槽下python。开始python代码执行报错，开始以为我环境或者版本问题，后来才发现是python2函数引起的问题。不知道python的bug程序员都怎么标注python版本？这个破问题我还查了半天。。。</p>
<h2 id="bcc-tools"><a href="#bcc-tools" class="headerlink" title="bcc&#x2F;tools"></a>bcc&#x2F;tools</h2><p>bcc还提供了很多其他工具，比如java或python的分析。</p>
<h2 id="iovisor-gobpf"><a href="#iovisor-gobpf" class="headerlink" title="iovisor&#x2F;gobpf"></a>iovisor&#x2F;gobpf</h2><p>这是个依赖bcc的go repo，可以将向bcc的python工具一样使用bcc功能。测试了非常简单的库github.com&#x2F;DavadDi&#x2F;bpf_demo，其中bpf_go_tracer监听go函数并且替换掉了其中的参数。</p>
<p>但是当我测试pixie-io&#x2F;pixie-demos遇到了问题。首先是因为版本问题buildsimple-gotracing&#x2F;http_trace_uprobe不通过，后来我升级了github.com&#x2F;iovisor&#x2F;gobpf版本又报了另一个错误：</p>
<pre><code>    ./utils.go:66:33: not enough arguments in call to _C2func_bpf_attach_uprobe
            have (_Ctype_int, uint32, *_Ctype_char, *_Ctype_char, _Ctype_ulong, _Ctype_int)
            want (_Ctype_int, uint32, *_Ctype_char, *_Ctype_char, _Ctype_ulong, _Ctype_int, _Ctype_uint)
</code></pre>
<p>utils.go有个bpf_attach_uprobe缺少了一个参数。看代码是因为bcc版本不对造成的，网上说用bcc 0.17没问题，不过我没有再测试了以后有时间再补上吧。</p>
<h1 id="TODO"><a href="#TODO" class="headerlink" title="TODO"></a>TODO</h1><p>bcc有很多工具。初步测算了tcpaccept&#x2F;tcptracer&#x2F;profile等。可以初步看看有用的工具。</p>
<p>遗留问题：</p>
<p>-需要查看为什么gethostlatency抓不到go的http请求<br>-怎么查看各种服务的http请求及处理结果<br>-pixie-io&#x2F;pixie-demos的simple-gotracing<br>-go处理拿到http以及funclantency</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/12/31/ebpf-install-and-test/" data-id="clufetd630000etcq8yxuc6hk" data-title="ebpf之bcc的安装及测试" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ebpf/" rel="tag">ebpf</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-hello-world" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/1970/01/01/hello-world/" class="article-date">
  <time class="dt-published" datetime="1970-01-01T00:00:00.000Z" itemprop="datePublished">1970-01-01</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/1970/01/01/hello-world/">Hello World</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>Welcome to <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a target="_blank" rel="noopener" href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a target="_blank" rel="noopener" href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a target="_blank" rel="noopener" href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/writing.html">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/server.html">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/generating.html">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/1970/01/01/hello-world/" data-id="clufetd6g0005etcq4hmj44ns" data-title="Hello World" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  


</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/devops/">devops</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/ebpf/" rel="tag">ebpf</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/ebpf/" style="font-size: 10px;">ebpf</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/03/">March 2024</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/12/">December 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/1970/01/">January 1970</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2024/03/31/recovery-1/">根因分析与⾃愈 -- 概述</a>
          </li>
        
          <li>
            <a href="/2021/12/31/ebpf-install-and-test/">ebpf之bcc的安装及测试</a>
          </li>
        
          <li>
            <a href="/1970/01/01/hello-world/">Hello World</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2024 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.6.4.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>